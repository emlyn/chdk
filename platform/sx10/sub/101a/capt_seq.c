#include "lolevel.h"
#include "platform.h"
#include "core.h"
#include "conf.h"

static long *nrflag = (long*)0x9B40;

#include "../../../generic/capt_seq.c"

void __attribute__((naked,noinline)) capt_seq_task() {
 asm volatile (
                 "STMFD   SP!, {R3-R9,LR}\n"
                 "LDR     R6, =0x5584\n"
                 "LDR     R4, =0x1BE24\n"
                 "MOV     R9, #1\n"
                 "MOV     R7, #0\n"
 "loc_FF868BAC:\n"
                 "LDR     R0, [R6,#0x14]\n"
                 "MOV     R2, #0\n"
                 "MOV     R1, SP\n"
                 "BL      sub_FF8274FC\n"
                 "TST     R0, #1\n"
                 "BEQ     loc_FF868BD8\n"
                 "LDR     R1, =0x539\n"
                 "LDR     R0, =0xFF86833C\n"
                 "BL      sub_FF81B1CC\n"
                 "BL      sub_FF81B184\n"
                 "LDMFD   SP!, {R3-R9,PC}\n"
 "loc_FF868BD8:\n"
                 "LDR     R0, [SP]\n"
                 "LDR     R1, [R0]\n"
                 "CMP     R1, #0x24\n"
                 "ADDLS   PC, PC, R1,LSL#2\n"
                 "B       loc_FF868EB4\n"
 "loc_FF868BEC:\n"
                 "B       loc_FF868C80\n"
 "loc_FF868BF0:\n"
                 "B       loc_FF868CEC\n"
 "loc_FF868BF4:\n"
                 "B       loc_FF868CF4\n"
 "loc_FF868BF8:\n"
                 "B       loc_FF868D18\n"
 "loc_FF868BFC:\n"
                 "B       loc_FF868D0C\n"
 "loc_FF868C00:\n"
                 "B       loc_FF868D20\n"
 "loc_FF868C04:\n"
                 "B       loc_FF868D28\n"
 "loc_FF868C08:\n"
                 "B       loc_FF868D30\n"
 "loc_FF868C0C:\n"
                 "B       loc_FF868D88\n"
 "loc_FF868C10:\n"
                 "B       loc_FF868DB0\n"
 "loc_FF868C14:\n"
                 "B       loc_FF868D94\n"
 "loc_FF868C18:\n"
                 "B       loc_FF868DA0\n"
 "loc_FF868C1C:\n"
                 "B       loc_FF868DA8\n"
 "loc_FF868C20:\n"
                 "B       loc_FF868DB8\n"
 "loc_FF868C24:\n"
                 "B       loc_FF868DC0\n"
 "loc_FF868C28:\n"
                 "B       loc_FF868DC8\n"
 "loc_FF868C2C:\n"
                 "B       loc_FF868DD0\n"
 "loc_FF868C30:\n"
                 "B       loc_FF868DD8\n"
 "loc_FF868C34:\n"
                 "B       loc_FF868DE0\n"
 "loc_FF868C38:\n"
                 "B       loc_FF868DE8\n"
 "loc_FF868C3C:\n"
                 "B       loc_FF868DF0\n"
 "loc_FF868C40:\n"
                 "B       loc_FF868DF8\n"
 "loc_FF868C44:\n"
                 "B       loc_FF868E00\n"
 "loc_FF868C48:\n"
                 "B       loc_FF868E08\n"
 "loc_FF868C4C:\n"
                 "B       loc_FF868E10\n"
 "loc_FF868C50:\n"
                 "B       loc_FF868E1C\n"
 "loc_FF868C54:\n"
                 "B       loc_FF868E24\n"
 "loc_FF868C58:\n"
                 "B       loc_FF868E30\n"
 "loc_FF868C5C:\n"
                 "B       loc_FF868E38\n"
 "loc_FF868C60:\n"
                 "B       loc_FF868E68\n"
 "loc_FF868C64:\n"
                 "B       loc_FF868E70\n"
 "loc_FF868C68:\n"
                 "B       loc_FF868E78\n"
 "loc_FF868C6C:\n"
                 "B       loc_FF868E80\n"
 "loc_FF868C70:\n"
                 "B       loc_FF868E88\n"
 "loc_FF868C74:\n"
                 "B       loc_FF868E90\n"
 "loc_FF868C78:\n"
                 "B       loc_FF868E9C\n"
 "loc_FF868C7C:\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868C80:\n"
                 "BL      sub_FF8694C0\n"
                 "BL      shooting_expo_param_override\n"  // +
                 "BL      sub_FF866550\n"

 //  this code added to avoid some incorrect behavior if overrides are used.
 //  but it can cause some unexpected side effects. In this case, remove this code!

                 "MOV     R0, #0\n"
                 "STR     R0, [R4,#0x24]\n"  // fixes overrides  behavior at short shutter press
 	
 //  end of my code

                 "LDR     R0, [R4,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF868EC0\n"
                 "BL      sub_FF86800C\n"  
                 "MOV     R5, R0\n"
                 "LDR     R0, [R4,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF868CC8\n"
                 "MOV     R0, #0xC\n"
                 "BL      sub_FF86D150\n"
                 "TST     R0, #1\n"
                 "STRNE   R9, [R6,#4]\n"
                 "LDRNE   R0, [R5,#8]\n"
                 "ORRNE   R0, R0, #0x40000000\n"
                 "STRNE   R0, [R5,#8]\n"
                 "BNE     loc_FF868EC0\n"
 "loc_FF868CC8:\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF94C28C\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF8683EC\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF94C964_my\n"             // ----------->
                 "BL      capt_seq_hook_raw_here\n"      // +
                 "TST     R0, #1\n"
                 "STRNE   R9, [R6,#4]\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868CEC:\n"
                 "BL      sub_FF868464_my\n"             // ----------->
                 "B       loc_FF868D10\n"
 "loc_FF868CF4:\n"
                 "MOV     R0, #1\n"
                 "BL      sub_FF869734\n"
                 "LDR     R0, [R4,#0xC]\n"
                 "CMP     R0, #0\n"
                 "BLNE    sub_FF86A238\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868D0C:\n"
                 "BL      sub_FF86918C\n"
 "loc_FF868D10:\n"
                 "STR     R7, [R4,#0x24]\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868D18:\n"
                 "BL      sub_FF8694A0\n"
                 "B       loc_FF868D10\n"
 "loc_FF868D20:\n"
                 "BL      sub_FF8694A8\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868D28:\n"
                 "BL      sub_FF869624\n"
                 "B       loc_FF868D8C\n"
 "loc_FF868D30:\n"
                 "LDR     R5, [R0,#0xC]\n"
                 "BL      sub_FF8694B0\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF94B270\n"
                 "TST     R0, #1\n"
                 "MOV     R8, R0\n"
                 "BNE     loc_FF868D70\n"
                 "BL      sub_FF879868\n"
                 "STR     R0, [R5,#0x18]\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF94C820\n"
                 "MOV     R0, R5\n"
                 "BL      sub_FF94CC2C\n"
                 "MOV     R8, R0\n"
                 "LDR     R0, [R5,#0x18]\n"
                 "BL      sub_FF879A7C\n"
 "loc_FF868D70:\n"
                 "BL      sub_FF8694A0\n"
                 "MOV     R2, R5\n"
                 "MOV     R1, #9\n"
                 "MOV     R0, R8\n"
                 "BL      sub_FF866ADC\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868D88:\n"
                 "BL      sub_FF8696B4\n"
 "loc_FF868D8C:\n"
                 "BL      sub_FF866550\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868D94:\n"
                 "LDR     R0, [R4,#0x54]\n"
                 "BL      sub_FF869D4C\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DA0:\n"
                 "BL      sub_FF869FF8\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DA8:\n"
                 "BL      sub_FF86A088\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DB0:\n"
                 "BL      sub_FF8694A0\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DB8:\n"
                 "BL      sub_FF94B4B0\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DC0:\n"
                 "BL      sub_FF94B6DC\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DC8:\n"
                 "BL      sub_FF94B770\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DD0:\n"
                 "BL      sub_FF94B898\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DD8:\n"
                 "BL      sub_FF94B94C\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DE0:\n"
                 "BL      sub_FF94BDDC\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DE8:\n"
                 "BL      sub_FF94BE34\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868DF0:\n"
                 "MOV     R0, #0\n"
                 "B       loc_FF868E14\n"
 "loc_FF868DF8:\n"
                 "BL      sub_FF94BFD0\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E00:\n"
                 "BL      sub_FF94C060\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E08:\n"
                 "BL      sub_FF94C120\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E10:\n"
                 "MOV     R0, #1\n"
 "loc_FF868E14:\n"
                 "BL      sub_FF94BEA8\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E1C:\n"
                 "BL      sub_FF86996C\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E24:\n"
                 "BL      sub_FF869A0C\n"
                 "BL      sub_FF868FE8\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E30:\n"
                 "BL      sub_FF94BC04\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E38:\n"
                 "MOV     R2, #2\n"
                 "ADD     R1, R4, #0x74\n"
                 "MOV     R0, #0x6F\n"
                 "BL      sub_FF8796D8\n"
                 "TST     R0, #1\n"
                 "LDRNE   R1, =0x61C\n"
                 "LDRNE   R0, =0xFF86833C\n"
                 "BLNE    sub_FF81B1CC\n"
                 "LDRH    R0, [R4,#0x74]\n"
                 "CMP     R0, #1\n"
                 "BLEQ    sub_FF94BBF8\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E68:\n"
                 "BL      sub_FF94BD30\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E70:\n"
                 "BL      sub_FF8682CC\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E78:\n"
                 "BL      sub_FF824960\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E80:\n"
                 "BL      sub_FF86B890\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E88:\n"
                 "BL      sub_FF86B8F8\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E90:\n"
                 "BL      sub_FF86B954\n"
                 "BL      sub_FF86B914\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868E9C:\n"
                 "MOV     R0, #1\n"
                 "BL      sub_FF94D430\n"
                 "LDRH    R0, [R4,#0xA0]\n"
                 "CMP     R0, #3\n"
                 "BLNE    sub_FF86BB10\n"
                 "B       loc_FF868EC0\n"
 "loc_FF868EB4:\n"
                 "LDR     R1, =0x65E\n"
                 "LDR     R0, =0xFF86833C\n"
                 "BL      sub_FF81B1CC\n"
 "loc_FF868EC0:\n"
                 "LDR     R0, [SP]\n"
                 "LDR     R1, [R0,#4]\n"
                 "LDR     R0, [R6,#0x10]\n"
                 "BL      sub_FF871404\n"
                 "LDR     R5, [SP]\n"
                 "LDR     R0, [R5,#8]\n"
                 "CMP     R0, #0\n"
                 "LDREQ   R1, =0x11D\n"
                 "LDREQ   R0, =0xFF86833C\n"
                 "BLEQ    sub_FF81B1CC\n"
                 "STR     R7, [R5,#8]\n"
                 "B       loc_FF868BAC\n"
 );
} 



void __attribute__((naked,noinline)) sub_FF868464_my(){ // 
 asm volatile(
                 "STMFD   SP!, {R3-R9,LR}\n"
                 "LDR     R4, [R0,#0xC]\n"
                 "LDR     R5, =0x1BE24\n"
                 "LDR     R0, [R4,#8]\n"
                 "LDR     R6, =0x820A\n"
                 "ORR     R0, R0, #1\n"
                 "STR     R0, [R4,#8]\n"
                 "LDRH    R0, [R5]\n"
                 "LDR     R8, =0x5584\n"
                 "MOV     R7, #0\n"
                 "CMP     R0, R6\n"
                 "BEQ     loc_FF868508\n"
                 "LDRH    R0, [R5,#0xA6]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF868568\n"
                 "LDR     R0, [R4,#0xC]\n"
                 "CMP     R0, #1\n"
                 "BLS     loc_FF868514\n"
                 "LDRH    R0, [R5,#0xA4]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF868568\n"
                 "LDRH    R0, [R5,#0xA0]\n"
                 "CMP     R0, #2\n"
                 "BNE     loc_FF868520\n"
                 "BL      sub_FF869ABC\n"
                 "LDRH    R0, [R5]\n"
                 "CMP     R0, R6\n"
                 "BEQ     loc_FF868508\n"
                 "LDRH    R0, [R5,#0xA6]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF868568\n"
                 "LDR     R0, [R4,#0xC]\n"
                 "CMP     R0, #1\n"
                 "BLS     loc_FF868514\n"
                 "LDRH    R0, [R5,#0xA4]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF868568\n"
                 "LDRH    R0, [R5,#0xA0]\n"
                 "CMP     R0, #2\n"
                 "BEQ     loc_FF86854C\n"
                 "B       loc_FF868520\n"
 "loc_FF868508:\n"
                 "LDRH    R0, [R5,#0xA6]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF868568\n"
 "loc_FF868514:\n"
                 "LDRH    R0, [R5,#0xA4]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF868568\n"
 "loc_FF868520:\n"
                 "LDRH    R0, [R5,#0xA0]\n"
                 "CMP     R0, #1\n"
                 "BNE     loc_FF868568\n"
                 "LDRH    R0, [R5]\n"
                 "CMP     R0, R6\n"
                 "LDRNE   R0, [R4,#0xC]\n"
                 "CMPNE   R0, #1\n"
                 "BLS     loc_FF868568\n"
                 "LDR     R0, [R4,#0x10]\n"
                 "CMP     R0, #1\n"
                 "BNE     loc_FF868568\n"
 "loc_FF86854C:\n"
                 "LDR     R3, =0x24D\n"
                 "LDR     R2, =0xEA60\n"
                 "STR     R3, [SP]\n"
                 "LDR     R0, [R8,#0x10]\n"
                 "LDR     R3, =0xFF86833C\n"
                 "MOV     R1, #0x40000000\n"
                 "BL      sub_FF86D4D4\n"
 "loc_FF868568:\n"
                 "BL      sub_FF8682CC\n"
                 "LDR     R0, [R5,#0x24]\n"
                 "CMP     R0, #0\n"
                 "MOVEQ   R0, #2\n"
                 "BLEQ    sub_FF861ADC\n"
                 "BL      sub_FF8694B0\n"
                 "LDR     R0, [R5,#0x24]\n"
                 "CMP     R0, #0\n"
                 "BNE     loc_FF868620\n"
                 "MOV     R0, #0\n"
                 "BL      sub_FF94D430\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF94C28C\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF8698D4\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF94AE14\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF8685D8\n"
                 "BL      sub_FF94D470\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF94AFD8\n"
                 "TST     R0, #1\n"
                 "MOVNE   R2, R4\n"
                 "LDMNEFD SP!, {R3-R9,LR}\n"
                 "MOVNE   R1, #1\n"
                 "BNE     sub_FF866ADC\n"
                 "B       loc_FF8685FC\n"
 "loc_FF8685D8:\n"
                 "LDR     R0, [R5,#0xC]\n"
                 "CMP     R0, #0\n"
                 "BEQ     loc_FF8685F0\n"
                 "BL      sub_FF86A1C0\n"
                 "BL      sub_FF900298\n"
                 "BL      sub_FF863254\n"
 "loc_FF8685F0:\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF94AF0C\n"
                 "BL      sub_FF94D470\n"
 "loc_FF8685FC:\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF8683EC\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF94C820\n"
                 "BL      sub_FF94D2C0\n"
                 "MOV     R0, R4\n"
                 "BL      sub_FF94C964_my\n"             //----------->
                 "MOV     R7, R0\n"
                 "BL      capt_seq_hook_raw_here\n"      // +
                 "B       loc_FF86862C\n"
 "loc_FF868620:\n"
                 "LDR     R0, [R8,#4]\n"
                 "CMP     R0, #0\n"
                 "MOVNE   R7, #0x1D\n"
 "loc_FF86862C:\n"
                 "BL      sub_FF86B8F8\n"
                 "BL      sub_FF86B940\n"
                 "BL      sub_FF86B980\n"
                 "MOV     R2, R4\n"
                 "MOV     R1, #1\n"
                 "MOV     R0, R7\n"
                 "BL      sub_FF866ADC\n"
                 "BL      sub_FF94CBBC\n"
                 "CMP     R0, #0\n"
                 "LDRNE   R0, [R4,#8]\n"
                 "ORRNE   R0, R0, #0x2000\n"
                 "STRNE   R0, [R4,#8]\n"
                 "LDR     R0, [R4,#0x1C]\n"
                 "CMP     R0, #0\n"
                 "BLNE    sub_FF86326C\n"
                 "LDRH    R0, [R5,#0xA6]\n"
                 "CMP     R0, #3\n"
                 "BEQ     loc_FF868690\n"
                 "LDRH    R0, [R5,#0xA4]\n"
                 "CMP     R0, #0\n"
                 "LDREQH  R0, [R5,#0xA0]\n"
                 "CMPEQ   R0, #2\n"
                 "MOVEQ   R0, R4\n"
                 "LDMEQFD SP!, {R3-R9,LR}\n"
                 "BEQ     sub_FF869B10\n"
 "loc_FF868690:\n"
                 "LDMFD   SP!, {R3-R9,PC}\n"
 );
}



void __attribute__((naked,noinline)) sub_FF94C964_my(){ // 
 asm volatile(
                 "STMFD   SP!, {R1-R7,LR}\n"
                 "MOV     R4, R0\n"
                 "BL      sub_FF94D5A0\n"
                 "MVN     R1, #0\n"
                 "BL      sub_FF871438\n"
                 "MOV     R2, #4\n"
                 "ADD     R1, SP, #4\n"
                 "MOV     R0, #0x8A\n"
                 "BL      sub_FF8796D8\n"
                 "TST     R0, #1\n"
                 "LDRNE   R1, =0x373\n"
                 "LDRNE   R0, =0xFF94C930\n"
                 "BLNE    sub_FF81B1CC\n"
                 "LDR     R7, =0x1BEF8\n"
                 "LDR     R6, =0x1BE24\n"
                 "LDRSH   R1, [R7,#0xE]\n"
                 "LDR     R0, [R6,#0x9C]\n"
                 "BL      sub_FF90B00C\n"
                 "BL      sub_FF84E5F0\n"
                 "LDR     R3, =0x9B44\n"
                 "STRH    R0, [R4,#0x94]\n"
                 "STR     R3, [SP]\n"
                 "MOV     R1, R0\n"
                 "LDRH    R0, [R6,#0x70]\n"
                 "LDRSH   R2, [R7,#0xC]\n"
                 "SUB     R3, R3, #4\n"
                 "BL      sub_FF94DBC4\n"
                 "BL      wait_until_remote_button_is_released\n"
                 "BL      capt_seq_hook_set_nr\n"                     // +
                 "B       sub_FF94C9D0\n"                             // continue function in firmware
 );
}
