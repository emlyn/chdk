#include "conf.h"

void change_video_tables(int a, int b){
}


void  set_quality(int *x){ // -17 highest; +12 lowest
 if (conf.video_mode) *x=12-((conf.video_quality-1)*(12+17)/(99-1));
}

void __attribute__((naked,noinline)) movie_record_task(){ 

 asm volatile(
		"STMFD	SP!, {R2-R8,LR}\n"
		"LDR	R8, =0x425\n"
		"LDR	R7, =0x2710\n"
		"LDR	R4, =0x2BF8\n"
		"MOV	R6, #0\n"
		"MOV	R5, #1\n"
"loc_FF87909C:\n" //				; CODE XREF: task_MovieRecord+140j\n"
		"LDR	R0, [R4,#0x18]\n"
		"MOV	R2, #0\n"
		"ADD	R1, SP,	#4\n"			// previous "ADD	R1, SP,	#0x4\n"	
		"BL	sub_FF838318\n"
		"LDR	R2, =0xFF877658\n"
		"LDR	R0, [R4,#0xB4]\n"
		"MOV	R3, R8\n"
		"MOV	R1, R7\n"
		"BL	sub_FF838C14\n"
		"LDR	R0, [R4,#0x20]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF87919C\n"
		"LDR	R0, [SP,#4]\n"  //"LDR	R0, [SP,#0x4]\n"
		"LDR	R1, [R0]\n"
		"SUB	R1, R1,	#2\n"
		"CMP	R1, #0xB\n"
		"ADDLS	PC, PC,	R1,LSL#2\n"
		"B	loc_FF87919C\n"
"loc_FF8790E4:	B	loc_FF879144\n"
"loc_FF8790E8:	B	loc_FF87915C\n"
"loc_FF8790EC:	B	loc_FF87916C\n"
"loc_FF8790F0:	B	loc_FF879174\n"
"loc_FF8790F4:	B	loc_FF87914C\n"
"loc_FF8790F8:	B	loc_FF87917C\n"
"loc_FF8790FC:	B	loc_FF879154\n"
"loc_FF879100:	B	loc_FF87919C\n"
"loc_FF879104:	B	loc_FF87918C\n"
"loc_FF879108:	B	loc_FF879194\n"
"loc_FF87910C:	B	loc_FF879184\n"
"loc_FF879110:	B	loc_FF879114\n"
"loc_FF879114:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"LDR	R0, =0xFF878D30\n"
		"STR	R6, [R4,#0x34]\n"
		"STR	R0, [R4,#0x9C]\n"
		"LDR	R0, =0xFF877B70\n"
		"LDR	R2, =0xFF877B74\n"
		"STR	R0, [R4,#0xA0]\n"
		"LDR	R0, =0xFF877C84\n"
		"LDR	R1, =0x385FC\n" // changed from 385DC to 385FC
		"STR	R6, [R4,#0x24]\n"
		"BL	sub_FF84EE4C\n"
		"STR	R5, [R4,#0x38]\n"
		"B	loc_FF87919C\n" 

"loc_FF879144:\n" //				; CODE XREF: task_MovieRecord+58j\n"
//		"BL      unlock_optical_zoom\n" //  + already unlocked in SX20
		"BL	sub_FF878E58\n"
		"B	loc_FF87919C\n"
"loc_FF87914C:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		//"BL	sub_FF878924\n"
				"BL	sub_FF878974_my\n"	// "BL	sub_FF878924_my\n" // what is this?
		"B	loc_FF87919C\n"
"loc_FF879154:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF8793CC\n"
		"B	loc_FF87919C\n"
"loc_FF87915C:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"LDR	R0, [R4,#0x38]\n"
		"CMP	R0, #5\n"
		"STRNE	R5, [R4,#0x28]\n"
		"B	loc_FF87919C\n"
"loc_FF87916C:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF878674\n"
		"B	loc_FF87919C\n"
"loc_FF879174:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF878324\n"
		"B	loc_FF87919C\n"
"loc_FF87917C:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF877AFC\n"
		"B	loc_FF87919C\n"
"loc_FF879184:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF879334\n"
		"B	loc_FF87919C\n"
"loc_FF87918C:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF8781E8\n"
		"B	loc_FF87919C\n"
"loc_FF879194:\n" //				; CODE XREF: task_MovieRecord+58j\n"
		"BL	sub_FF8780CC\n"
		"STR	R5, [R4,#0xDC]\n"
"loc_FF87919C:\n" //				; CODE XREF: task_MovieRecord+44j\n"
		"LDR	R1, [SP,#4]\n"	//"LDR	R1, [SP,#0x4]\n"
		"MOV	R3, #0x460\n"
		"STR	R6, [R1]\n"
		"STR	R3, [SP]\n"
		"LDR	R0, [R4,#0x1C]\n"
		"LDR	R3, =0xFF877658\n"
		"MOV	R2, R7\n"
		"BL	sub_FF838C6C\n"
		"LDR	R0, [R4,#0xB4]\n"
		"BL	sub_FF838804\n"
		"B	loc_FF87909C\n"
 );
}

// done upto here

void __attribute__((naked,noinline)) sub_FF878974_my(){ 
 asm volatile(
		"STMFD	SP!, {R4-R8,LR}\n"
		"SUB	SP, SP,	#0x48\n"
		"MOV	R7, #0\n"
		"LDR	R6, =0x2BF8\n"
		"MOV	R4, R0\n"
		"STR	R7, [SP,#0x38]\n"
		"STR	R7, [SP,#0x30]\n"
		"LDR	R0, [R6,#0x38]\n"
		"CMP	R0, #3\n"
		"MOVEQ	R0, #4\n"
		"STREQ	R0, [R6,#0x38]\n"
		"LDR	R0, [R6,#0x9C]\n"
		"BLX	R0\n"
		"LDR	R0, [R6,#0x38]\n"
		"CMP	R0, #4\n"
		"BNE	loc_FF878A98\n"
		"ADD	R3, SP,	#0x30\n"
		"ADD	R2, SP,	#0x34\n"
		"ADD	R1, SP,	#0x38\n"
		"ADD	R0, SP,	#0x3C\n"
		"BL	sub_FF95BC7C\n"
		"CMP	R0, #0\n"
		"MOV	R5, #1\n"
		"BNE	loc_FF8789F0\n"
		"LDR	R1, [R6,#0x28]\n"
		"CMP	R1, #1\n"
		"BNE	loc_FF878AA0\n"
		"LDR	R1, [R6,#0x4C]\n"
		"LDR	R2, [R6,#0x3C]\n"
		"CMP	R1, R2\n"
		"BCC	loc_FF878AA0\n"
"loc_FF8789F0:\n" //				; CODE XREF: sub_FF878924+5Cj\n"
		"BL	sub_FF877CC4\n"
		"BL	sub_FF879320\n"
		"LDR	R0, [R4,#0x1C]\n"
		"ADD	R4, SP,	#0x18\n"
		"ADD	R3, SP,	#0x40\n"
//		"MOVL	R2, 0xFFFFFFFE\n"
		"MVN     R2, #1\n"
		"MOV	R1, #0\n"
		"STMIA	R4, {R0-R3}\n"
		"LDR	R2, [R6,#0x64]\n"
		"LDR	R3, [R6,#0x68]\n"
		"ADD	R1, SP,	#0x44\n"
		"ADD	R4, SP,	#8\n"
		"MOV	R0, #0\n"
		"STMIA	R4, {R0-R3}\n"
		"MOV	R3, #0\n"
		"MOV	R2, #0x40\n"
		"STRD	R2, [SP]\n"
		"LDR	R3, =0x38668\n"
		"MOV	R2, #0\n"
		"MOV	R1, #0\n"
		"BL	sub_FF918908\n"
		"LDR	R0, [R6,#0x10]\n"
		"MOV	R1, #0x3E8\n"
		"BL	sub_FF838734\n"
		"CMP	R0, #9\n"
		"BNE	loc_FF878A68\n"
"loc_FF878A58:\n" //				; CODE XREF: sub_FF878924+1ACj\n"
		"BL	sub_FF95C150\n"
		"MOV	R0, #1\n"
		"STR	R5, [R6,#0x38]\n"
		"B	loc_FF878BC8\n" 
"loc_FF878A68:\n" //				; CODE XREF: sub_FF878924+E0j\n"
		"LDR	R0, [SP,#0x40]\n"
		"CMP	R0, #0\n"
		"BEQ	loc_FF878A84\n"
"loc_FF878A74:\n" //				; CODE XREF: sub_FF878924+1B8j\n"
		"BL	sub_FF95C150\n"
		"MOV	R0, #1\n"
		"STR	R5, [R6,#0x38]\n"
		"B	loc_FF878BF4\n"
"loc_FF878A84:\n" //				; CODE XREF: sub_FF878924+FCj\n"
		"MOV	R0, #1\n"
		"BL	sub_FF9189B0\n"
		"BL	sub_FF9189EC\n"
		"MOV	R0, #5\n"
		"STR	R0, [R6,#0x38]\n"
"loc_FF878A98:\n" //				; CODE XREF: sub_FF878924+3Cj\n"
		"ADD	SP, SP,	#0x48\n"
		"LDMFD	SP!, {R4-R8,PC}\n"
"loc_FF878AA0:\n" //				; CODE XREF: sub_FF878924+68j\n"
		"LDR	R12, [SP,#0x38]\n"
		"CMP	R12, #0\n"
		"BEQ	loc_FF878CD8\n"
		"STR	R5, [R6,#0x2C]\n"
		"LDR	R0, [R6,#0x4C]\n"
		"LDR	R8, [R4,#0xC]\n"
		"CMP	R0, #0\n"
		"LDRNE	LR, [SP,#0x3C]\n"
		"BNE	loc_FF878B4C\n"
		"LDR	R0, [R4,#0x1C]\n"
		"LDR	R1, [R4,#0x20]\n"
		"ADD	R3, SP,	#0x40\n"
//		"MOVL	R2, 0xFFFFFFFF\n"
		"MVN     R2, #0\n"
		"ADD	LR, SP,	#0x18\n"
		"STMIA	LR, {R0-R3}\n"
		"LDR	R0, [SP,#0x30]\n"
		"LDR	R2, [R6,#0x64]\n"
		"LDR	R3, [R6,#0x68]\n"
		"ADD	R1, SP,	#0x44\n"
		"ADD	LR, SP,	#8\n"
		"STMIA	LR, {R0-R3}\n"
		"LDR	R3, [SP,#0x34]\n"
		"STR	R12, [SP]\n"
		"STR	R3, [SP,#4]\n"
		"LDMIB	R4, {R0,R1}\n"
		"LDR	R3, [SP,#0x3C]\n"
		"MOV	R2, R8\n"
		"BL	sub_FF918908\n"
		"LDR	R0, [R6,#0x10]\n"
		"MOV	R1, #0x3E8\n"
		"BL	sub_FF838734\n"
		"CMP	R0, #9\n"
		"BEQ	loc_FF878A58\n"
		"LDR	R0, [SP,#0x40]\n"
		"CMP	R0, #0\n"
		"BNE	loc_FF878A74\n"
		"MOV	R0, #1\n"
		"BL	sub_FF9189B0\n"
		"LDR	R0, [SP,#0x44]\n"
		"LDR	R1, [SP,#0x3C]\n"
		"ADD	LR, R1,	R0\n"
		"LDR	R1, [SP,#0x38]\n"
		"SUB	R12, R1, R0\n"
"loc_FF878B4C:\n" //				; CODE XREF: sub_FF878924+14Cj\n"
		"LDR	R2, [R6,#0x48]\n"
		"LDR	R0, [R4,#0x1C]\n"
		"LDR	R1, [R4,#0x20]\n"
		"ADD	R3, SP,	#0x40\n"
		"STR	R1, [SP,#0x1C]\n"
		"STR	R0, [SP,#0x18]\n"
		"STR	R3, [SP,#0x24]\n"
		"STR	R2, [SP,#0x20]\n"
		"LDR	R2, [R6,#0x64]\n"
		"LDR	R3, [R6,#0x68]\n"
		"ADD	R1, SP,	#0x44\n"
		"STR	R1, [SP,#0xC]\n"
		"STR	R3, [SP,#0x14]\n"
		"LDR	R3, [SP,#0x34]\n"
		"LDR	R0, [SP,#0x30]\n"
		"STR	R2, [SP,#0x10]\n"
		"STR	R3, [SP,#0x4]\n"
		"STR	R12, [SP]\n"
		"STR	R0, [SP,#0x8]\n"
		"LDMIB	R4, {R0,R1}\n"
		"MOV	R3, LR\n"
		"MOV	R2, R8\n"
		"BL	sub_FF918908\n"
		"LDR	R0, [R6,#0x10]\n"
		"MOV	R1, #0x3E8\n"
		"BL	sub_FF838734\n"
		"CMP	R0, #9\n"
		"BNE	loc_FF878BDC\n"
		"BL	sub_FF95C150\n"
		"MOV	R0, #0\n"
		"STR	R5, [R6,#0x38]\n"
"loc_FF878BC8:\n" //				; CODE XREF: sub_FF878924+F0j\n"
		"BL	sub_FF9189B0\n"
		"MOV	R0, #0xC\n"
		"BL	sub_FF889D6C\n"
		"MOV	R0, #0x90000\n"
		"B	loc_FF878C04\n"
"loc_FF878BDC:\n" //				; CODE XREF: sub_FF878924+244j\n"
		"LDR	R0, [SP,#0x40]\n"
		"CMP	R0, #0\n"
		"BEQ	loc_FF878C18\n"
		"BL	sub_FF95C150\n"
		"MOV	R0, #0\n"
		"STR	R5, [R6,#0x38]\n"
"loc_FF878BF4:\n" //				; CODE XREF: sub_FF878924+10Cj\n"
		"BL	sub_FF9189B0\n"
		"MOV	R0, #0xC\n"
		"BL	sub_FF889D6C\n"
		"MOV	R0, #0xA0000\n"
"loc_FF878C04:\n" //				; CODE XREF: sub_FF878924+264j\n"
		"BL	sub_FF897198\n"
		"LDR	R1, [R6,#0x8C]!\n"
		"LDR	R0, [R6,#0xC]\n"
		"BLX	R1\n"
		"B	loc_FF878A98\n"
"loc_FF878C18:\n" //				; CODE XREF: sub_FF878924+270j\n"
		"MOV	R0, #0\n"
		"BL	sub_FF9189B0\n"
		"LDR	R0, [R6,#0xDC]\n"
		"CMP	R0, #1\n"
		"BNE	loc_FF878CA8\n"
		"LDR	R0, [R6,#0x48]\n"
		"MOV	R1, #0xF\n"
		"BL	sub_FFB384CC\n"
		"MOVS	R4, R1\n"
		"STREQ	R7, [R6,#0xDC]\n"
		"BEQ	loc_FF878CA8\n"
		"LDR	R5, [SP,#0x3C]\n"
		"MOV	R2, #4\n"
		"ADD	R0, SP,	#0x2C\n"
		"ADD	R1, R5,	#4\n"
		"BL	sub_FFB36870\n"
		"LDR	R0, [SP,#0x2C]\n"
		"MOV	R1, R0,LSR#24\n"
		"AND	R2, R0,	#0xFF0000\n"
		"ORR	R1, R1,	R2,LSR#8\n"
		"AND	R2, R0,	#0xFF00\n"
		"ORR	R1, R1,	R2,LSL#8\n"
		"ORR	R0, R1,	R0,LSL#24\n"
		"BIC	R0, R0,	#0x1E000\n"
		"ORR	R0, R0,	R4,LSL#13\n"
		"MOV	R1, R0,LSR#24\n"
		"AND	R2, R0,	#0xFF0000\n"
		"ORR	R1, R1,	R2,LSR#8\n"
		"AND	R2, R0,	#0xFF00\n"
		"ORR	R1, R1,	R2,LSL#8\n"
		"ORR	R0, R1,	R0,LSL#24\n"
		"STR	R0, [SP,#0x2C]\n"
		"ADD	R0, R5,	#4\n"
		"ADD	R1, SP,	#0x2C\n"
		"MOV	R2, #4\n"
		"BL	sub_FFB36870\n"
"loc_FF878CA8:\n" //				; CODE XREF: sub_FF878924+2B4j\n"
		"LDR	R0, [SP,#0x3C]\n"
		"LDR	R1, [SP,#0x44]\n"
		"BL	sub_FF95BEA8\n"
		"LDR	R0, [R6,#0x48]\n"
		"LDR	R3, =0x2C60\n"    // ->
		"ADD	R1, R0,	#1\n"
		"STR	R1, [R6,#0x48]\n"
		"STR	R3, [SP]\n"
		"LDR	R0, [SP,#0x44]\n"
		"SUB	R3, R3,	#4\n"     // ->
		"MOV	R2, #0xF\n"
		"BL	sub_FF959F2C\n"

                "LDR     R0, =0x2C60-4\n" // <----   -4 //+
                "BL      set_quality\n"                 //+
		
"loc_FF878CD8:\n" //				; CODE XREF: sub_FF878924+134j\n"
		"LDR	R0, [R6,#0x4C]\n"
		"ADD	R0, R0,	#1\n"
		"STR	R0, [R6,#0x4C]\n"
		"LDR	R1, [R6,#0x74]\n"
		"MUL	R0, R1,	R0\n"
		"LDR	R1, [R6,#0x70]\n"
		"BL	sub_FFB384CC\n"
		"MOV	R4, R0\n"
		"BL	sub_FF95C188\n"
		"LDR	R1, [R6,#0x6C]\n"
		"CMP	R1, R4\n"
		"BNE	loc_FF878D14\n"
		"LDR	R0, [R6,#0x30]\n"
		"CMP	R0, #1\n"
		"BNE	loc_FF878D28\n"
"loc_FF878D14:\n" //				; CODE XREF: sub_FF878924+390j\n"
		"LDR	R1, [R6,#0x80]\n"
		"MOV	R0, R4\n"
		"BLX	R1\n"
		"STR	R4, [R6,#0x6C]\n"
		"STR	R7, [R6,#0x30]\n"
"loc_FF878D28:\n" //				; CODE XREF: sub_FF878924+39Cj\n"
		"STR	R7, [R6,#0x2C]\n"
		"B	loc_FF878A98\n"
 );
}

